"""
Main application setup for Flask and SQLAlchemy
"""
import os
import logging
from flask import Flask, render_template, request, jsonify, redirect, url_for, flash, send_from_directory, make_response
from werkzeug.utils import secure_filename
from dotenv import load_dotenv
from extensions import db, migrate, login_manager, mail, limiter, csrf
from datetime import timedelta, datetime
from database.models import User, SiteSetting, Banner, Subscription, Order, MealPlan, Delivery, Newsletter, CouponCode, DeliveryLocation
from flask_wtf.csrf import CSRFError
from routes.main_routes import main_bp
from routes.admin_routes import admin_bp
from routes.admin_orders import admin_orders_bp
from routes_pwa import pwa_bp
from blueprints import register_blueprints
from commands import init_app as init_commands
from config import Config
from utils.filters import timeago, multiply_decimal
from utils.email_utils import send_email
import razorpay
from flask_login import login_user, logout_user, login_required, current_user
from werkzeug.security import generate_password_hash, check_password_hash
from itsdangerous import URLSafeTimedSerializer
from flask_mail import Message

# Load environment variables
load_dotenv()

def create_app(config_class=Config):
    """Create and configure the Flask application"""
    app = Flask(__name__, template_folder='templates', static_folder='static')
    
    # Load configuration
    app.config.from_object(config_class)
    
    # Initialize extensions
    db.init_app(app)
    migrate.init_app(app, db)
    login_manager.init_app(app)
    mail.init_app(app)
    limiter.init_app(app)
    csrf.init_app(app)

    # Register blueprints
    register_blueprints(app)
    
    # Configure login manager
    login_manager.login_view = 'main.login'
    login_manager.login_message_category = 'info'
    
    # Add user loader
    @login_manager.user_loader
    def load_user(user_id):
        with app.app_context():
            return User.query.get(int(user_id))
    
    # Configure logging - reduce for production
    if app.config.get('DEBUG', False):
        logging.basicConfig(level=logging.INFO)
    else:
        logging.basicConfig(level=logging.WARNING)
    logger = logging.getLogger(__name__)
    logger.setLevel(logging.INFO)
    
    # Add template context processor for current datetime in IST
    @app.context_processor
    def inject_now():
        try:
            from utils.timezone_utils import get_current_ist_time
            return {'now': get_current_ist_time()}
        except ImportError:
            return {'now': datetime.utcnow()}

    @app.context_processor
    def inject_site_settings():
        """Inject all site settings into the template context"""
        try:
            settings = SiteSetting.query.all()
            settings_dict = {setting.key: setting.value for setting in settings}
            
            essential_defaults = {
                'site_logo': '/static/images/logo white.png',
                'hero_subtitle': 'In Supervision Of Nutrition Experts',
                'company_name': 'HealthyRizz',
                'company_tagline': 'Healthy Meal Delivery',
                'contact_phone': '8054090043',
                'contact_email': 'healthyrizz.in@gmail.com',
                'company_address': 'Ludhiana, Punjab, India',
                'facebook_url': 'https://facebook.com/healthyrizz',
                'instagram_url': 'https://instagram.com/healthyrizz.india',
                'show_social_links': 'True',
                'show_fssai_badge': 'True',
                'show_hygiene_badge': 'True',
                'hygiene_badge_text': '100% Hygienic'
            }
            
            for key, default_value in essential_defaults.items():
                if key not in settings_dict:
                    settings_dict[key] = default_value
            
            return {'site_settings': settings_dict}
        except Exception as e:
            app.logger.error(f"Could not inject site settings: {e}")
            return {'site_settings': {
                'site_logo': '/static/images/logo white.png',
                'hero_subtitle': 'In Supervision Of Nutrition Experts',
                'company_name': 'HealthyRizz',
                'company_tagline': 'Healthy Meal Delivery',
                'contact_phone': '8054090043',
                'contact_email': 'healthyrizz.in@gmail.com',
                'company_address': 'Ludhiana, Punjab, India',
                'facebook_url': 'https://facebook.com/healthyrizz',
                'instagram_url': 'https://instagram.com/healthyrizz.india',
                'show_social_links': 'True',
                'show_fssai_badge': 'True',
                'show_hygiene_badge': 'True',
                'hygiene_badge_text': '100% Hygienic'
            }}

    @app.context_processor
    def inject_active_banner():
        """Inject active banner into template context"""
        try:
            banner = Banner.get_active_banner()
            return {'active_banner': banner}
        except Exception as e:
            app.logger.error(f"Could not inject active banner: {e}")
            return {'active_banner': None}

    @app.context_processor
    def inject_csrf_token():
        """Inject CSRF token into template context"""
        try:
            return {'csrf_token': csrf._get_token()}
        except AttributeError:
            # Fallback for CSRF token generation
            try:
                from flask_wtf.csrf import generate_csrf
                return {'csrf_token': generate_csrf()}
            except ImportError:
                return {'csrf_token': 'dummy-csrf-token'}

    # CSRF error handler
    @app.errorhandler(CSRFError)
    def handle_csrf_error(e):
        return render_template('errors/csrf_error.html'), 400

    # Initialize commands
    init_commands(app)

    # Add template filters
    app.jinja_env.filters['timeago'] = timeago
    app.jinja_env.filters['multiply_decimal'] = multiply_decimal

    # Add direct favicon route as fallback
    @app.route('/favicon.ico')
    def favicon_fallback():
        """Serve favicon from static folder"""
        return send_from_directory('static', 'favicon.ico')

    @app.route('/service-worker.js')
    def service_worker():
        """Serve the service worker file"""
        response = make_response(send_from_directory('static/js', 'service-worker.js'))
        response.headers['Content-Type'] = 'application/javascript'
        response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
        response.headers['Pragma'] = 'no-cache'
        response.headers['Expires'] = '0'
        return response

    @app.route('/manifest.json')
    def manifest():
        """Serve the manifest file"""
        response = make_response(send_from_directory('static', 'manifest.json'))
        response.headers['Content-Type'] = 'application/json'
        return response
    
    @app.route('/clear-service-worker')
    def clear_service_worker():
        """Serve the service worker clearing helper page"""
        return send_from_directory('.', 'force_clear_service_worker.html')
    
    @app.route('/clear-cache')
    def clear_cache():
        """Serve the cache clearing page"""
        return send_from_directory('.', 'clear-cache.html')

    # Initialize Razorpay client
    razorpay_client = razorpay.Client(
        auth=(app.config['RAZORPAY_KEY_ID'], app.config['RAZORPAY_KEY_SECRET'])
    )

    def send_order_confirmation_email(subscription):
        """Send order confirmation email"""
        try:
            subject = "Order Confirmation - HealthyRizz"
            html_content = f"""
            <html>
            <body>
                <h2>Order Confirmation</h2>
                <p>Your order has been confirmed successfully!</p>
                <p>Subscription ID: {subscription.id}</p>
                <p>Status: {subscription.status}</p>
            </body>
            </html>
            """
            
            return send_email(
                to_email=subscription.user.email,
                from_email='no-reply@healthyrizz.in',
                subject=subject,
                html_content=html_content
            )
        except Exception as e:
            app.logger.error(f"Failed to send order confirmation email: {str(e)}")
            return False

    def send_payment_failure_email(subscription):
        """Send payment failure notification email"""
        try:
            subject = "Payment Failed - HealthyRizz"
            html_content = f"""
            <html>
            <body>
                <h2>Payment Failed</h2>
                <p>We're sorry, but your payment has failed.</p>
                <p>Subscription ID: {subscription.id}</p>
                <p>Please try again or contact support.</p>
            </body>
            </html>
            """
            
            return send_email(
                to_email=subscription.user.email,
                from_email='no-reply@healthyrizz.in',
                subject=subject,
                html_content=html_content
            )
        except Exception as e:
            app.logger.error(f"Failed to send payment failure email: {str(e)}")
            return False

    @app.route('/razorpay-webhook', methods=['POST'])
    @csrf.exempt
    def razorpay_webhook():
        """Handle Razorpay webhook"""
        try:
            # Verify webhook signature
            webhook_signature = request.headers.get('X-Razorpay-Signature')
            webhook_secret = app.config['RAZORPAY_WEBHOOK_SECRET']
            
            # Verify the webhook
            razorpay_client.utility.verify_webhook_signature(
                request.data.decode(),
                webhook_signature,
                webhook_secret
            )
            
            # Parse the webhook data
            webhook_data = request.get_json()
            event_type = webhook_data.get('event')
            
            if event_type == 'payment.captured':
                # Handle successful payment
                payment_id = webhook_data['payload']['payment']['entity']['id']
                
                # Find the subscription by payment ID
                subscription = Subscription.query.filter_by(razorpay_payment_id=payment_id).first()
                
                if subscription:
                    subscription.status = 'active'
                    subscription.payment_status = 'paid'
                    db.session.commit()
                    
                    # Send confirmation email
                    send_order_confirmation_email(subscription)
                    
                    app.logger.info(f"Payment successful for subscription {subscription.id}")
                else:
                    app.logger.warning(f"Subscription not found for payment {payment_id}")
                    
            elif event_type == 'payment.failed':
                # Handle failed payment
                payment_id = webhook_data['payload']['payment']['entity']['id']
                
                subscription = Subscription.query.filter_by(razorpay_payment_id=payment_id).first()
                
                if subscription:
                    subscription.status = 'failed'
                    subscription.payment_status = 'failed'
                    db.session.commit()
                    
                    # Send failure email
                    send_payment_failure_email(subscription)
                    
                    app.logger.info(f"Payment failed for subscription {subscription.id}")
                else:
                    app.logger.warning(f"Subscription not found for failed payment {payment_id}")
            
            return jsonify({'status': 'success'}), 200
            
        except Exception as e:
            app.logger.error(f"Webhook error: {str(e)}")
            return jsonify({'status': 'error', 'message': str(e)}), 400

    @app.route('/profile/deliveries')
    @login_required
    def deliveries():
        """Show user's delivery history"""
        user_deliveries = Delivery.query.filter_by(user_id=current_user.id).order_by(Delivery.created_at.desc()).all()
        return render_template('profile/deliveries.html', deliveries=user_deliveries)

    @app.route('/cart-checkout')
    @login_required
    def cart_checkout():
        """Handle cart checkout"""
        # Get user's cart items
        cart_items = request.args.getlist('items[]')
        total_amount = request.args.get('total', 0, type=float)
        
        return render_template('checkout.html', cart_items=cart_items, total_amount=total_amount)

    @app.route('/subscribe-newsletter', methods=['POST'])
    def subscribe_newsletter():
        """Handle newsletter subscription"""
        try:
            email = request.form.get('email')
            
            if not email:
                return jsonify({'success': False, 'message': 'Email is required'})
            
            # Check if already subscribed
            existing = Newsletter.query.filter_by(email=email).first()
            if existing:
                return jsonify({'success': False, 'message': 'Email already subscribed'})
            
            # Create new subscription
            newsletter = Newsletter(email=email)
            db.session.add(newsletter)
            db.session.commit()
            
            return jsonify({'success': True, 'message': 'Successfully subscribed to newsletter'})
            
        except Exception as e:
            app.logger.error(f"Newsletter subscription error: {str(e)}")
            return jsonify({'success': False, 'message': 'An error occurred'})

    @app.route('/checkout-success')
    def checkout_success():
        """Handle successful checkout"""
        return render_template('checkout_success.html')

    @app.route('/checkout-cancel')
    def checkout_cancel():
        """Handle cancelled checkout"""
        return render_template('checkout_cancel.html')

    @app.route('/order-confirmation/<int:order_id>')
    @login_required
    def order_confirmation(order_id):
        """Show order confirmation page"""
        order = Order.query.get_or_404(order_id)
        if order.user_id != current_user.id:
            flash('You can only view your own orders.', 'error')
            return redirect(url_for('main.profile'))
        return render_template('order_confirmation.html', order=order)

    @app.errorhandler(404)
    def page_not_found(e):
        return render_template('errors/404.html'), 404

    @app.errorhandler(401)
    def unauthorized(error):
        return render_template('errors/401.html'), 401

    # Security headers middleware
    @app.after_request
    def add_security_headers(response):
        response.headers['X-Content-Type-Options'] = 'nosniff'
        response.headers['X-Frame-Options'] = 'SAMEORIGIN'
        response.headers['X-XSS-Protection'] = '1; mode=block'
        response.headers['Strict-Transport-Security'] = 'max-age=31536000; includeSubDomains'
        
        # Fixed CSP to allow CSS and other resources properly
        response.headers['Content-Security-Policy'] = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://checkout.razorpay.com https://js.razorpay.com https://api.razorpay.com https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.tailwindcss.com https://fonts.gstatic.com https://unpkg.com https://cdn.jsdelivr.net; img-src 'self' data: https: blob:; connect-src 'self' https://api.razorpay.com https://lumberjack.razorpay.com; font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com https://fonts.googleapis.com; object-src 'none'; media-src 'self'; frame-src 'self' https://checkout.razorpay.com https://api.razorpay.com;"
        
        # Add cache control for static files to prevent caching issues
        if request.path.startswith('/static/'):
            if request.path.endswith(('.css', '.js')):
                response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
                response.headers['Pragma'] = 'no-cache'
                response.headers['Expires'] = '0'
            else:
                response.headers['Cache-Control'] = 'public, max-age=3600'
        
        return response

    # Password reset helper functions
    def generate_password_reset_token(user, expires_sec=3600):
        s = URLSafeTimedSerializer(app.config['SECRET_KEY'])
        return s.dumps(user.email, salt='password-reset-salt')

    def verify_password_reset_token(token, expires_sec=3600):
        s = URLSafeTimedSerializer(app.config['SECRET_KEY'])
        try:
            email = s.loads(token, salt='password-reset-salt', max_age=expires_sec)
        except Exception:
            return None
        return email

    def send_password_reset_email(to_email, token):
        try:
            from flask_mail import Message
            from extensions import mail
            from flask import url_for
            
            # Create reset URL
            reset_url = url_for("main.reset_password", token=token, _external=True)
            
            # Create message
            msg = Message(
                subject="Password Reset Request - HealthyRizz",
                sender=app.config.get("MAIL_DEFAULT_SENDER", "noreply@healthyrizz.in"),
                recipients=[to_email]
            )
            
            msg.body = f"""To reset your password, visit the following link:
{reset_url}

If you did not make this request, simply ignore this email.
"""
            
            # Send email
            mail.send(msg)
            print(f"Password reset email sent to {to_email}")
            return True
            
        except Exception as e:
            print(f"Error sending password reset email: {str(e)}")
            return False

    return app

app = create_app()

if __name__ == '__main__':
    app.run(debug=True)
