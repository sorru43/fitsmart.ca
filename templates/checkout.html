<<<<<<< HEAD
{% extends "base.html" %}

{% block title %}Checkout - {{ meal_plan.name }} - HealthyRizz{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-white mb-8">Complete Your Order</h1>
        
        <div class="grid md:grid-cols-2 gap-8">
            <!-- Order Form -->
            <div class="bg-darker p-6 rounded-lg border border-gray-800">
                <h2 class="text-xl font-semibold mb-6 text-white">Customer Information</h2>
                
                <form id="checkout-form" method="POST" action="{{ url_for('main.process_checkout') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="plan_id" value="{{ meal_plan.id }}">
                    <input type="hidden" name="frequency" value="{{ frequency }}">
                    <input type="hidden" name="total_amount" value="{{ total_amount }}">
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Full Name *</label>
                            <input type="text" name="customer_name" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600" 
                                   value="{{ user_data.name if user_data else '' }}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Email Address *</label>
                            <input type="email" name="customer_email" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600"
                                   value="{{ user_data.email if user_data else '' }}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Phone Number *</label>
                            <input type="tel" name="customer_phone" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600"
                                   value="{{ user_data.phone if user_data else '' }}">
                        </div>
                        
                        <!-- Cascading Location Dropdowns -->
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">State *</label>
                            <select name="customer_state" id="state-select" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600">
                                <option value="">Select State</option>
                                {% for state in states %}
                                <option value="{{ state.name }}" {% if user_data and user_data.state == state.name %}selected{% endif %}>
                                    {{ state.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">City *</label>
                            <select name="customer_city" id="city-select" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600" disabled>
                                <option value="">Select City</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Area *</label>
                            <select name="customer_area" id="area-select" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600" disabled>
                                <option value="">Select Area</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Complete Address *</label>
                            <textarea name="customer_address" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600" rows="3" 
                                      placeholder="Enter your complete delivery address">{{ user_data.address if user_data else '' }}</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">PIN Code *</label>
                            <input type="text" name="customer_pincode" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600"
                                   value="{{ user_data.postal_code if user_data else '' }}" maxlength="6" pattern="[0-9]{6}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Delivery Instructions</label>
                            <textarea name="delivery_instructions" class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600" rows="2" 
                                      placeholder="Any special delivery instructions (optional)"></textarea>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <button type="submit" id="pay-button" class="w-full bg-primary text-white py-3 px-6 rounded-md hover:bg-green-600 font-semibold">
                            <i class="fas fa-credit-card mr-2"></i>Proceed to Payment (Rs. {{ "%.2f"|format(total_amount) }})
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Order Summary -->
            <div class="bg-darker p-6 rounded-lg border border-gray-800">
                <h2 class="text-xl font-semibold mb-6 text-white">Order Summary</h2>
                
                <div class="space-y-4">
                    <div class="flex justify-between">
                        <span class="text-gray-300">Plan:</span>
                        <span class="text-white font-semibold">{{ meal_plan.name }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Frequency:</span>
                        <span class="text-white">{{ frequency.title() }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Base Price:</span>
                        <span class="text-white">Rs. {{ "%.2f"|format(base_price) }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">GST (5%):</span>
                        <span class="text-white">Rs. {{ "%.2f"|format(gst_amount) }}</span>
                    </div>
                    <div class="border-t border-gray-700 pt-4">
                        <div class="flex justify-between font-semibold text-lg">
                            <span class="text-white">Total:</span>
                            <span class="text-primary">Rs. {{ "%.2f"|format(total_amount) }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Plan Details -->
                <div class="mt-6 pt-6 border-t border-gray-700">
                    <h3 class="text-lg font-semibold text-white mb-3">Plan Details</h3>
                    <div class="space-y-2 text-sm text-gray-300">
                        <p>• {{ meal_plan.description }}</p>
                        <p>• {{ meal_plan.meals_per_day }} meals per day</p>
                        <p>• {{ meal_plan.days_per_week }} days per week</p>
                        {% if meal_plan.vegetarian_options %}
                        <p>• Vegetarian options available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
// Cascading dropdown functionality
document.addEventListener('DOMContentLoaded', function() {
    const stateSelect = document.getElementById('state-select');
    const citySelect = document.getElementById('city-select');
    const areaSelect = document.getElementById('area-select');
    
    // State change handler
    stateSelect.addEventListener('change', function() {
        const selectedState = this.value;
        
        // Reset city and area dropdowns
        citySelect.innerHTML = '<option value="">Select City</option>';
        areaSelect.innerHTML = '<option value="">Select Area</option>';
        citySelect.disabled = !selectedState;
        areaSelect.disabled = true;
        
        if (selectedState) {
            // Fetch cities for selected state
            fetch(`/get-delivery-cities?state=${encodeURIComponent(selectedState)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.cities.length > 0) {
                        data.cities.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city.name;
                            option.textContent = city.name;
                            citySelect.appendChild(option);
                        });
                        citySelect.disabled = false;
                    } else {
                        citySelect.innerHTML = '<option value="">No cities available</option>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching cities:', error);
                    citySelect.innerHTML = '<option value="">Error loading cities</option>';
                });
        }
    });
    
    // City change handler
    citySelect.addEventListener('change', function() {
        const selectedCity = this.value;
        const selectedState = stateSelect.value;
        
        // Reset area dropdown
        areaSelect.innerHTML = '<option value="">Select Area</option>';
        areaSelect.disabled = !selectedCity;
        
        if (selectedCity) {
            // Fetch areas for selected city
            fetch(`/get-delivery-areas?state=${encodeURIComponent(selectedState)}&city=${encodeURIComponent(selectedCity)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.areas.length > 0) {
                        data.areas.forEach(area => {
                            const option = document.createElement('option');
                            option.value = area.name;
                            option.textContent = area.name;
                            areaSelect.appendChild(option);
                        });
                        areaSelect.disabled = false;
                    } else {
                        areaSelect.innerHTML = '<option value="">No areas available</option>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching areas:', error);
                    areaSelect.innerHTML = '<option value="">Error loading areas</option>';
                });
        }
    });
});

// Form submission handler
document.getElementById('checkout-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate location selection
    const stateSelect = document.getElementById('state-select');
    const citySelect = document.getElementById('city-select');
    const areaSelect = document.getElementById('area-select');
    
    if (!stateSelect.value || !citySelect.value || !areaSelect.value) {
        alert('Please select State, City, and Area');
        return;
    }
    
    const button = document.getElementById('pay-button');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
    
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrf_token')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const options = {
                key: data.key_id,
                amount: data.amount,
                currency: data.currency,
                name: 'HealthyRizz',
                description: data.description,
                order_id: data.order_id,
                handler: function(response) {
                    // Payment successful - submit verification
                    const verifyForm = document.createElement('form');
                    verifyForm.method = 'POST';
                    verifyForm.action = '{{ url_for("main.verify_payment") }}';
                    verifyForm.style.display = 'none';
                    
                    // Add CSRF token
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrf_token';
                    csrfInput.value = formData.get('csrf_token');
                    verifyForm.appendChild(csrfInput);
                    
                    // Add payment details
                    const paymentIdInput = document.createElement('input');
                    paymentIdInput.type = 'hidden';
                    paymentIdInput.name = 'razorpay_payment_id';
                    paymentIdInput.value = response.razorpay_payment_id;
                    verifyForm.appendChild(paymentIdInput);
                    
                    const orderIdInput = document.createElement('input');
                    orderIdInput.type = 'hidden';
                    orderIdInput.name = 'razorpay_order_id';
                    orderIdInput.value = response.razorpay_order_id;
                    verifyForm.appendChild(orderIdInput);
                    
                    const signatureInput = document.createElement('input');
                    signatureInput.type = 'hidden';
                    signatureInput.name = 'razorpay_signature';
                    signatureInput.value = response.razorpay_signature;
                    verifyForm.appendChild(signatureInput);
                    
                    document.body.appendChild(verifyForm);
                    verifyForm.submit();
                },
                prefill: {
                    name: formData.get('customer_name'),
                    email: formData.get('customer_email'),
                    contact: formData.get('customer_phone')
                },
                theme: {
                    color: '#4CAF50'
                }
            };
            
            const rzp = new Razorpay(options);
            rzp.open();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your checkout.');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Proceed to Payment (Rs. {{ "%.2f"|format(total_amount) }})';
    });
});
</script>
{% endblock %}
=======
{% extends "base.html" %}

{% block title %}Checkout - {{ meal_plan.name }} - HealthyRizz{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-white mb-8">Complete Your Order</h1>
        
        <div class="grid md:grid-cols-2 gap-8">
            <!-- Order Form -->
            <div class="bg-darker p-6 rounded-lg border border-gray-800">
                <h2 class="text-xl font-semibold mb-6 text-white">Customer Information</h2>
                
                <form id="checkout-form" method="POST" action="{{ url_for('main.process_checkout') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="plan_id" value="{{ meal_plan.id }}">
                    <input type="hidden" name="frequency" value="{{ frequency }}">
                    <input type="hidden" name="total_amount" value="{{ total_amount }}">
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Full Name *</label>
                            <input type="text" name="customer_name" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600" 
                                   value="{{ user_data.name if user_data else '' }}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Email Address *</label>
                            <input type="email" name="customer_email" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600"
                                   value="{{ user_data.email if user_data else '' }}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Phone Number *</label>
                            <input type="tel" name="customer_phone" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600"
                                   value="{{ user_data.phone if user_data else '' }}">
                        </div>
                        
                        <!-- Cascading Location Dropdowns -->
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">State *</label>
                            <select name="customer_state" id="state-select" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600">
                                <option value="">Select State</option>
                                {% for state in states %}
                                <option value="{{ state.name }}" {% if user_data and user_data.state == state.name %}selected{% endif %}>
                                    {{ state.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">City *</label>
                            <select name="customer_city" id="city-select" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600" disabled>
                                <option value="">Select City</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Area *</label>
                            <select name="customer_area" id="area-select" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600" disabled>
                                <option value="">Select Area</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Complete Address *</label>
                            <textarea name="customer_address" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600" rows="3" 
                                      placeholder="Enter your complete delivery address">{{ user_data.address if user_data else '' }}</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">PIN Code *</label>
                            <input type="text" name="customer_pincode" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600"
                                   value="{{ user_data.postal_code if user_data else '' }}" maxlength="6" pattern="[0-9]{6}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Delivery Instructions</label>
                            <textarea name="delivery_instructions" class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600" rows="2" 
                                      placeholder="Any special delivery instructions (optional)"></textarea>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <button type="submit" id="pay-button" class="w-full bg-primary text-white py-3 px-6 rounded-md hover:bg-green-600 font-semibold">
                            <i class="fas fa-credit-card mr-2"></i>Proceed to Payment (Rs. {{ "%.2f"|format(total_amount) }})
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Order Summary -->
            <div class="bg-darker p-6 rounded-lg border border-gray-800">
                <h2 class="text-xl font-semibold mb-6 text-white">Order Summary</h2>
                
                <div class="space-y-4">
                    <div class="flex justify-between">
                        <span class="text-gray-300">Plan:</span>
                        <span class="text-white font-semibold">{{ meal_plan.name }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Frequency:</span>
                        <span class="text-white">{{ frequency.title() }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Base Price:</span>
                        <span class="text-white">Rs. {{ "%.2f"|format(base_price) }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">GST (5%):</span>
                        <span class="text-white">Rs. {{ "%.2f"|format(gst_amount) }}</span>
                    </div>
                    <div class="border-t border-gray-700 pt-4">
                        <div class="flex justify-between font-semibold text-lg">
                            <span class="text-white">Total:</span>
                            <span class="text-primary">Rs. {{ "%.2f"|format(total_amount) }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Plan Details -->
                <div class="mt-6 pt-6 border-t border-gray-700">
                    <h3 class="text-lg font-semibold text-white mb-3">Plan Details</h3>
                    <div class="space-y-2 text-sm text-gray-300">
                        <p>• {{ meal_plan.description }}</p>
                        <p>• {{ meal_plan.meals_per_day }} meals per day</p>
                        <p>• {{ meal_plan.days_per_week }} days per week</p>
                        {% if meal_plan.vegetarian_options %}
                        <p>• Vegetarian options available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
// Cascading dropdown functionality
document.addEventListener('DOMContentLoaded', function() {
    const stateSelect = document.getElementById('state-select');
    const citySelect = document.getElementById('city-select');
    const areaSelect = document.getElementById('area-select');
    
    // State change handler
    stateSelect.addEventListener('change', function() {
        const selectedState = this.value;
        
        // Reset city and area dropdowns
        citySelect.innerHTML = '<option value="">Select City</option>';
        areaSelect.innerHTML = '<option value="">Select Area</option>';
        citySelect.disabled = !selectedState;
        areaSelect.disabled = true;
        
        if (selectedState) {
            // Fetch cities for selected state
            fetch(`/get-delivery-cities?state=${encodeURIComponent(selectedState)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.cities.length > 0) {
                        data.cities.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city.name;
                            option.textContent = city.name;
                            citySelect.appendChild(option);
                        });
                        citySelect.disabled = false;
                    } else {
                        citySelect.innerHTML = '<option value="">No cities available</option>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching cities:', error);
                    citySelect.innerHTML = '<option value="">Error loading cities</option>';
                });
        }
    });
    
    // City change handler
    citySelect.addEventListener('change', function() {
        const selectedCity = this.value;
        const selectedState = stateSelect.value;
        
        // Reset area dropdown
        areaSelect.innerHTML = '<option value="">Select Area</option>';
        areaSelect.disabled = !selectedCity;
        
        if (selectedCity) {
            // Fetch areas for selected city
            fetch(`/get-delivery-areas?state=${encodeURIComponent(selectedState)}&city=${encodeURIComponent(selectedCity)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.areas.length > 0) {
                        data.areas.forEach(area => {
                            const option = document.createElement('option');
                            option.value = area.name;
                            option.textContent = area.name;
                            areaSelect.appendChild(option);
                        });
                        areaSelect.disabled = false;
                    } else {
                        areaSelect.innerHTML = '<option value="">No areas available</option>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching areas:', error);
                    areaSelect.innerHTML = '<option value="">Error loading areas</option>';
                });
        }
    });
});

// Form submission handler
document.getElementById('checkout-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate location selection
    const stateSelect = document.getElementById('state-select');
    const citySelect = document.getElementById('city-select');
    const areaSelect = document.getElementById('area-select');
    
    if (!stateSelect.value || !citySelect.value || !areaSelect.value) {
        alert('Please select State, City, and Area');
        return;
    }
    
    const button = document.getElementById('pay-button');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
    
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrf_token')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const options = {
                key: data.key_id,
                amount: data.amount,
                currency: data.currency,
                name: 'HealthyRizz',
                description: data.description,
                order_id: data.order_id,
                handler: function(response) {
                    // Payment successful - submit verification
                    const verifyForm = document.createElement('form');
                    verifyForm.method = 'POST';
                    verifyForm.action = '{{ url_for("main.verify_payment") }}';
                    verifyForm.style.display = 'none';
                    
                    // Add CSRF token
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrf_token';
                    csrfInput.value = formData.get('csrf_token');
                    verifyForm.appendChild(csrfInput);
                    
                    // Add payment details
                    const paymentIdInput = document.createElement('input');
                    paymentIdInput.type = 'hidden';
                    paymentIdInput.name = 'razorpay_payment_id';
                    paymentIdInput.value = response.razorpay_payment_id;
                    verifyForm.appendChild(paymentIdInput);
                    
                    const orderIdInput = document.createElement('input');
                    orderIdInput.type = 'hidden';
                    orderIdInput.name = 'razorpay_order_id';
                    orderIdInput.value = response.razorpay_order_id;
                    verifyForm.appendChild(orderIdInput);
                    
                    const signatureInput = document.createElement('input');
                    signatureInput.type = 'hidden';
                    signatureInput.name = 'razorpay_signature';
                    signatureInput.value = response.razorpay_signature;
                    verifyForm.appendChild(signatureInput);
                    
                    document.body.appendChild(verifyForm);
                    verifyForm.submit();
                },
                prefill: {
                    name: formData.get('customer_name'),
                    email: formData.get('customer_email'),
                    contact: formData.get('customer_phone')
                },
                theme: {
                    color: '#4CAF50'
                }
            };
            
            const rzp = new Razorpay(options);
            rzp.open();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your checkout.');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Proceed to Payment (Rs. {{ "%.2f"|format(total_amount) }})';
    });
});
</script>
{% endblock %}
>>>>>>> 81a4199426f7354dc222b670139539c5516ca07d
