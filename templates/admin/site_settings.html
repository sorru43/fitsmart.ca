{% extends 'admin/base_admin.html' %}

{% block title %}Site Settings - FitSmart{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-2xl font-bold text-white">Site Settings</h1>
        <a href="{{ url_for('admin.admin_media') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
            <i class="fas fa-arrow-left mr-2"></i>Back to Media
        </a>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="bg-dark-lighter rounded-lg shadow-md p-6">
            <form method="POST" novalidate>
                {{ csrf_token() }}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- General Information -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-semibold text-white border-b border-gray-600 pb-2">General Information</h3>
                        
                        <div>
                            <label for="company_name" class="block text-sm font-medium text-white mb-2">Company Name</label>
                            <input type="text" id="company_name" name="company_name" 
                                   value="{{ site_settings.company_name if site_settings else 'FitSmart' }}"
                                   class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary">
                        </div>

                        <div>
                            <label for="hero_subtitle" class="block text-sm font-medium text-white mb-2">Hero Subtitle</label>
                            <input type="text" id="hero_subtitle" name="hero_subtitle" 
                                   value="{{ site_settings.hero_subtitle if site_settings else 'In Supervision Of Nutrition Experts' }}"
                                   class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary">
                        </div>

                        <div>
                            <label for="site_logo" class="block text-sm font-medium text-white mb-2">Site Logo URL <span class="text-gray-400 text-xs">(Optional)</span></label>
                            <input type="text" id="site_logo" name="site_logo" 
                                   value="{{ site_settings.get('site_logo', '/static/images/logo white.png') }}"
                                   placeholder="https://example.com/logo.png (optional)"
                                   class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary">
                            <p class="text-gray-400 text-xs mt-1">Enter a direct URL to your logo image (leave empty if uploading file below)</p>
                        </div>

                        <div>
                            <label for="site_logo_file" class="block text-sm font-medium text-white mb-2">Or Upload New Logo <span class="text-gray-400 text-xs">(Optional)</span></label>
                            <input type="file" id="site_logo_file" name="site_logo_file"
                                   accept="image/png, image/jpeg, image/svg+xml, image/webp"
                                   class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary-dark cursor-pointer">
                            <p class="text-gray-400 text-xs mt-1">Supported formats: PNG, JPG, JPEG, SVG, WEBP. Recommended size: 200x60px or larger.</p>
                        </div>

                        <!-- Logo Preview -->
                        <div class="mt-4">
                            <h4 class="text-md font-semibold text-white mb-2">Current Logo Preview</h4>
                            <div class="bg-dark-lightest rounded-lg p-4 border border-gray-600 flex justify-center items-center h-24">
                                <img id="logo-preview" src="{{ site_settings.get('site_logo', '/static/images/logo white.png') }}" alt="Logo Preview" class="max-h-full max-w-full object-contain">
                            </div>
                        </div>

                        <div>
                            <label for="contact_email" class="block text-sm font-medium text-white mb-2">Contact Email</label>
                            <input type="email" id="contact_email" name="contact_email" 
                                   value="{{ site_settings.get('contact_email', 'FitSmart.in@gmail.com') }}"
                                   class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary">
                        </div>

                        <div>
                            <label for="contact_phone" class="block text-sm font-medium text-white mb-2">Contact Phone</label>
                            <input type="tel" id="contact_phone" name="contact_phone" 
                                   value="{{ site_settings.contact_phone if site_settings else '+1 (647) 573-2429' }}"
                                   class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary">
                        </div>

                        <!-- FSSAI Badge Settings -->
                        <div>
                            <label class="inline-flex items-center mt-2">
                                <input type="checkbox" id="show_fssai_badge" name="show_fssai_badge" class="form-checkbox h-5 w-5 text-primary" {% if site_settings.get('show_fssai_badge', 'True') == 'True' %}checked{% endif %}>
                                <span class="ml-2 text-white">Show FSSAI Badge</span>
                            </label>
                        </div>
                        <div>
                            <label for="fssai_license_number" class="block text-sm font-medium text-white mb-2">FSSAI License Number</label>
                            <input type="text" id="fssai_license_number" name="fssai_license_number" 
                                   value="{{ site_settings.get('fssai_license_number', '') }}"
                                   class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white">
                        </div>

                        <!-- Hygiene Badge Settings -->
                        <div class="mt-4 border-t border-gray-700 pt-4">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="show_hygiene_badge" name="show_hygiene_badge" class="form-checkbox h-5 w-5 text-primary" {% if site_settings.get('show_hygiene_badge', 'True') == 'True' %}checked{% endif %}>
                                <span class="ml-2 text-white">Show Hygiene Badge</span>
                            </label>
                        </div>
                        <div>
                            <label for="hygiene_badge_text" class="block text-sm font-medium text-white mb-2">Hygiene Badge Text</label>
                            <input type="text" id="hygiene_badge_text" name="hygiene_badge_text" 
                                   value="{{ site_settings.get('hygiene_badge_text', '100% Hygienic') }}"
                                   class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white">
                        </div>
                    </div>

                    <!-- Social Media -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-semibold text-white border-b border-gray-600 pb-2">Social Media</h3>
                        
                        <div>
                            <label for="facebook_url" class="block text-sm font-medium text-white mb-2">Facebook URL</label>
                            <input type="text" id="facebook_url" name="facebook_url" 
                                   value="{{ site_settings.get('facebook_url', 'https://facebook.com/FitSmart.in') }}"
                                   class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white">
                        </div>

                        <div>
                            <label for="instagram_url" class="block text-sm font-medium text-white mb-2">Instagram URL</label>
                            <input type="text" id="instagram_url" name="instagram_url" 
                                   value="{{ site_settings.instagram_url if site_settings else 'https://instagram.com/FitSmart.in' }}"
                                   placeholder="https://instagram.com/yourpage"
                                   class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary">
                        </div>

                        <!-- Preview Section -->
                        <div class="mt-8">
                            <h4 class="text-md font-semibold text-white mb-3">Preview</h4>
                            <div class="bg-dark-lightest rounded-lg p-4 border border-gray-600">
                                <div class="text-center">
                                    <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-gray-800 flex items-center justify-center">
                                        <i class="fas fa-image text-2xl text-gray-500"></i>
                                    </div>
                                    <h3 class="text-white font-semibold" id="preview-company">{{ site_settings.company_name if site_settings else 'FitSmart' }}</h3>
                                    <p class="text-gray-400 text-sm" id="preview-subtitle">{{ site_settings.hero_subtitle if site_settings else 'In Supervision Of Nutrition Experts' }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tracking Pixels -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-semibold text-white border-b border-gray-600 pb-2">Tracking Pixels</h3>
                        
                        <div>
                            <label for="facebook_pixel_id" class="block text-sm font-medium text-white mb-2">Facebook Pixel ID (Meta Pixel)</label>
                            <input type="text" id="facebook_pixel_id" name="facebook_pixel_id" 
                                   value="{{ site_settings.get('facebook_pixel_id', '') }}"
                                   placeholder="e.g., 123456789012345"
                                   class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary">
                            <p class="text-gray-400 text-xs mt-1">Enter your Facebook Pixel ID (found in Facebook Events Manager)</p>
                        </div>

                        <div>
                            <label for="google_analytics_id" class="block text-sm font-medium text-white mb-2">Google Analytics Measurement ID</label>
                            <input type="text" id="google_analytics_id" name="google_analytics_id" 
                                   value="{{ site_settings.get('google_analytics_id', '') }}"
                                   placeholder="e.g., G-XXXXXXXXXX"
                                   class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary">
                            <p class="text-gray-400 text-xs mt-1">Enter your Google Analytics 4 Measurement ID (starts with G-)</p>
                        </div>

                                                 <div class="bg-blue-900 bg-opacity-20 border border-blue-600 rounded-lg p-4">
                             <h4 class="text-blue-300 font-semibold mb-2">üìä Tracking Events</h4>
                             <p class="text-blue-200 text-sm mb-2">The following events will be automatically tracked:</p>
                             <ul class="text-blue-200 text-xs space-y-1">
                                 <li>‚Ä¢ Page views</li>
                                 <li>‚Ä¢ Purchase completions</li>
                                 <li>‚Ä¢ Add to cart actions</li>
                                 <li>‚Ä¢ Checkout initiation</li>
                                 <li>‚Ä¢ Newsletter signups</li>
                                 <li>‚Ä¢ Contact form submissions</li>
                                 <li>‚Ä¢ Lead generation</li>
                             </ul>
                         </div>
                     </div>

                     <!-- WhatsApp Business API -->
                     <div class="space-y-6">
                         <h3 class="text-lg font-semibold text-white border-b border-gray-600 pb-2">WhatsApp Business API</h3>
                         
                         <div>
                             <label for="whatsapp_phone_number_id" class="block text-sm font-medium text-white mb-2">WhatsApp Phone Number ID</label>
                             <input type="text" id="whatsapp_phone_number_id" name="whatsapp_phone_number_id" 
                                    value="{{ site_settings.get('whatsapp_phone_number_id', '') }}"
                                    placeholder="e.g., 123456789012345"
                                    class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary">
                             <p class="text-gray-400 text-xs mt-1">Your WhatsApp Business Phone Number ID (found in Meta Developer Console)</p>
                         </div>

                         <div>
                             <label for="whatsapp_access_token" class="block text-sm font-medium text-white mb-2">WhatsApp Access Token</label>
                             <input type="password" id="whatsapp_access_token" name="whatsapp_access_token" 
                                    value="{{ site_settings.get('whatsapp_access_token', '') }}"
                                    placeholder="Enter your WhatsApp Access Token"
                                    class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary">
                             <p class="text-gray-400 text-xs mt-1">Your WhatsApp Business API Access Token (keep this secure)</p>
                         </div>

                         <div>
                             <label for="whatsapp_business_account_id" class="block text-sm font-medium text-white mb-2">WhatsApp Business Account ID</label>
                             <input type="text" id="whatsapp_business_account_id" name="whatsapp_business_account_id" 
                                    value="{{ site_settings.get('whatsapp_business_account_id', '') }}"
                                    placeholder="e.g., 123456789012345"
                                    class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary">
                             <p class="text-gray-400 text-xs mt-1">Your WhatsApp Business Account ID (found in Meta Developer Console)</p>
                         </div>

                         <div>
                             <label for="whatsapp_webhook_verify_token" class="block text-sm font-medium text-white mb-2">Webhook Verify Token</label>
                             <div class="flex space-x-2">
                                 <input type="text" id="whatsapp_webhook_verify_token" name="whatsapp_webhook_verify_token" 
                                        value="{{ site_settings.get('whatsapp_webhook_verify_token', '') }}"
                                        placeholder="Enter a secure verify token"
                                        class="flex-1 px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary">
                                 <button type="button" id="generate-token" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">
                                     Generate
                                 </button>
                             </div>
                             <p class="text-gray-400 text-xs mt-1">Custom token for webhook verification (create a secure random string)</p>
                         </div>

                         <div class="bg-green-900 bg-opacity-20 border border-green-600 rounded-lg p-4">
                             <h4 class="text-green-300 font-semibold mb-2">üì± WhatsApp Features</h4>
                             <p class="text-green-200 text-sm mb-2">With WhatsApp Business API, you can:</p>
                             <ul class="text-green-200 text-xs space-y-1">
                                 <li>‚Ä¢ Send order confirmations</li>
                                 <li>‚Ä¢ Send delivery updates</li>
                                 <li>‚Ä¢ Send payment reminders</li>
                                 <li>‚Ä¢ Send promotional messages</li>
                                 <li>‚Ä¢ Automated customer support</li>
                                 <li>‚Ä¢ Newsletter broadcasts</li>
                                 <li>‚Ä¢ Birthday wishes</li>
                             </ul>
                         </div>

                         <div class="bg-yellow-900 bg-opacity-20 border border-yellow-600 rounded-lg p-4">
                             <h4 class="text-yellow-300 font-semibold mb-2">‚ö†Ô∏è Setup Instructions</h4>
                             <p class="text-yellow-200 text-xs mb-2">To complete WhatsApp setup:</p>
                             <ol class="text-yellow-200 text-xs space-y-1 list-decimal list-inside">
                                 <li>Create Meta Developer Account</li>
                                 <li>Set up WhatsApp Business API</li>
                                 <li>Configure webhook URL: <code class="bg-gray-800 px-1 rounded">https://yourdomain.com/webhook/whatsapp</code></li>
                                 <li>Add verify token above</li>
                                 <li>Test with sample phone numbers</li>
                             </ol>
                             
                             <div class="mt-4 pt-4 border-t border-yellow-600">
                                 <button type="button" id="test-whatsapp" class="w-full px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg text-sm">
                                     <i class="fas fa-test-tube mr-2"></i>Test WhatsApp Connection
                                 </button>
                                 <div id="whatsapp-test-result" class="mt-2 text-xs hidden"></div>
                             </div>
                         </div>
                     </div>
                     </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end space-x-4 mt-8 pt-6 border-t border-gray-600">
                    <a href="{{ url_for('admin.admin_media') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">
                        Cancel
                    </a>
                    <button type="submit" class="bg-primary hover:bg-primary-dark text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-save mr-2"></i>Save Settings
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Live preview for text inputs
document.getElementById('company_name').addEventListener('input', function() {
    document.getElementById('preview-company').textContent = this.value || 'FitSmart';
});
document.getElementById('hero_subtitle').addEventListener('input', function() {
    document.getElementById('preview-subtitle').textContent = this.value || 'In Supervision Of Nutrition Experts';
});

// Live preview for logo upload
document.getElementById('site_logo_file').addEventListener('change', function(event) {
    const preview = document.getElementById('logo-preview');
    const file = event.target.files[0];
    if (file) {
        preview.src = URL.createObjectURL(file);
        // When a file is chosen, clear the URL input to prioritize the upload
        document.getElementById('site_logo').value = '';
    }
});

// Handle logo URL input
document.getElementById('site_logo').addEventListener('input', function() {
    const preview = document.getElementById('logo-preview');
    const url = this.value.trim();
    if (url) {
        preview.src = url;
        // When URL is entered, clear the file input
        document.getElementById('site_logo_file').value = '';
    }
});

// Form submission handling
document.querySelector('form').addEventListener('submit', function(e) {
    const logoUrl = document.getElementById('site_logo');
    const logoFile = document.getElementById('site_logo_file');
    
    // Clear empty logo URL field to prevent validation issues
    if (logoUrl.value.trim() === '') {
        logoUrl.value = '';
    }
    
    // If no file is selected, clear the file input
    if (logoFile.files.length === 0) {
        logoFile.value = '';
    }
    
         // Both fields are optional, so form will submit successfully
     console.log('Form submitting with logo URL:', logoUrl.value);
     console.log('Form submitting with logo file:', logoFile.files.length > 0 ? 'File selected' : 'No file');
 });

// Generate secure webhook verify token
document.getElementById('generate-token').addEventListener('click', function() {
     const tokenInput = document.getElementById('whatsapp_webhook_verify_token');
     const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
     let token = '';
     for (let i = 0; i < 32; i++) {
         token += chars.charAt(Math.floor(Math.random() * chars.length));
     }
     tokenInput.value = token;
     tokenInput.focus();
 });

// Test WhatsApp connection
document.getElementById('test-whatsapp').addEventListener('click', function() {
     const button = this;
     const resultDiv = document.getElementById('whatsapp-test-result');
     
     // Get current form values
     const phoneNumberId = document.getElementById('whatsapp_phone_number_id').value;
     const accessToken = document.getElementById('whatsapp_access_token').value;
     const businessAccountId = document.getElementById('whatsapp_business_account_id').value;
     
     if (!phoneNumberId || !accessToken || !businessAccountId) {
         resultDiv.innerHTML = '<div class="text-red-400">‚ùå Please fill in all WhatsApp API fields first</div>';
         resultDiv.classList.remove('hidden');
         return;
     }
     
     // Show loading state
     button.disabled = true;
     button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
     resultDiv.innerHTML = '<div class="text-yellow-400">üîÑ Testing WhatsApp API connection...</div>';
     resultDiv.classList.remove('hidden');
     
     // Test API connection
     fetch('/admin/test-whatsapp-connection', {
         method: 'POST',
         headers: {
             'Content-Type': 'application/json',
             'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
         },
         body: JSON.stringify({
             phone_number_id: phoneNumberId,
             access_token: accessToken,
             business_account_id: businessAccountId
         })
     })
     .then(response => response.json())
     .then(data => {
         if (data.success) {
             resultDiv.innerHTML = '<div class="text-green-400">‚úÖ WhatsApp API connection successful!</div>';
         } else {
             resultDiv.innerHTML = '<div class="text-red-400">‚ùå ' + (data.error || 'Connection failed') + '</div>';
         }
     })
     .catch(error => {
         resultDiv.innerHTML = '<div class="text-red-400">‚ùå Network error: ' + error.message + '</div>';
     })
     .finally(() => {
         button.disabled = false;
         button.innerHTML = '<i class="fas fa-test-tube mr-2"></i>Test WhatsApp Connection';
     });
 });
</script>
{% endblock %} 
