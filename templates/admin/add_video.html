{% extends 'admin/base_admin.html' %}

{% block title %}Add Video - HealthyRizz{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-2xl font-bold text-white">Add Video</h1>
            <p class="text-gray-400 mt-1">Upload a video file or add a YouTube video</p>
        </div>
        <a href="{{ url_for('admin.admin_media') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
            <i class="fas fa-arrow-left mr-2"></i>Back to Media
        </a>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Form -->
            <div class="lg:col-span-2">
                <div class="bg-dark-lighter rounded-lg shadow-md p-6">
                    <form method="POST" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        
                        <div class="space-y-6">
                            <!-- Video Type Selection -->
                            <div>
                                {{ form.video_type.label(class="block text-sm font-medium text-white mb-2") }}
                                <div class="grid grid-cols-2 gap-4">
                                    {% for choice in form.video_type %}
                                        <label class="flex items-center p-4 border border-gray-600 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors">
                                            {{ choice(class="mr-3") }}
                                            <div>
                                                <div class="font-medium text-white">
                                                    {% if choice.data == 'youtube' %}
                                                        <i class="fab fa-youtube text-red-500 mr-2"></i>YouTube Video
                                                    {% else %}
                                                        <i class="fas fa-cloud-upload-alt text-green-500 mr-2"></i>Upload Video
                                                    {% endif %}
                                                </div>
                                                <div class="text-sm text-gray-400">
                                                    {% if choice.data == 'youtube' %}
                                                        Embed from YouTube
                                                    {% else %}
                                                        Upload MP4, WebM, AVI, MOV
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </label>
                                    {% endfor %}
                                </div>
                                {% if form.video_type.errors %}
                                    <p class="text-red-500 text-sm mt-1">{{ form.video_type.errors[0] }}</p>
                                {% endif %}
                            </div>

                            <!-- Title -->
                            <div>
                                {{ form.title.label(class="block text-sm font-medium text-white mb-2") }}
                                {{ form.title(class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary", placeholder="Enter video title") }}
                                {% if form.title.errors %}
                                    <p class="text-red-500 text-sm mt-1">{{ form.title.errors[0] }}</p>
                                {% endif %}
                            </div>

                            <!-- Description -->
                            <div>
                                {{ form.description.label(class="block text-sm font-medium text-white mb-2") }}
                                {{ form.description(class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary", rows="4", placeholder="Enter video description") }}
                                {% if form.description.errors %}
                                    <p class="text-red-500 text-sm mt-1">{{ form.description.errors[0] }}</p>
                                {% endif %}
                            </div>

                            <!-- YouTube URL (shown when YouTube is selected) -->
                            <div id="youtube-section" style="display: none;">
                                {{ form.youtube_url.label(class="block text-sm font-medium text-white mb-2") }}
                                <div class="flex space-x-2">
                                    {{ form.youtube_url(class="flex-1 px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary", placeholder="https://www.youtube.com/watch?v=VIDEO_ID") }}
                                    <button type="button" onclick="generateThumbnail()" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                        <i class="fas fa-image mr-1"></i>Auto Thumbnail
                                    </button>
                                </div>
                                {% if form.youtube_url.errors %}
                                    <p class="text-red-500 text-sm mt-1">{{ form.youtube_url.errors[0] }}</p>
                                {% endif %}
                            </div>

                            <!-- Video File Upload (shown when Upload is selected) -->
                            <div id="upload-section" style="display: none;">
                                {{ form.video_file.label(class="block text-sm font-medium text-white mb-2") }}
                                <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center hover:border-primary transition-colors" id="video-drop-zone">
                                    {{ form.video_file(class="hidden", id="video_file_input", accept="video/*") }}
                                    <div id="drop-text">
                                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                        <p class="text-white mb-2">Drop your video file here or <span class="text-primary cursor-pointer" onclick="document.getElementById('video_file_input').click()">browse</span></p>
                                        <p class="text-sm text-gray-400">Supported formats: MP4, WebM, AVI, MOV (Max: 100MB)</p>
                                    </div>
                                    <div id="video-preview" style="display: none;">
                                        <i class="fas fa-video text-green-500 text-2xl mb-2"></i>
                                        <p class="text-green-400 font-medium" id="video-filename"></p>
                                        <p class="text-sm text-gray-400" id="video-filesize"></p>
                                        <button type="button" onclick="clearVideoFile()" class="text-red-500 hover:text-red-400 mt-2">
                                            <i class="fas fa-trash mr-1"></i>Remove
                                        </button>
                                    </div>
                                </div>
                                {% if form.video_file.errors %}
                                    <p class="text-red-500 text-sm mt-1">{{ form.video_file.errors[0] }}</p>
                                {% endif %}
                            </div>

                            <!-- Thumbnail Upload -->
                            <div>
                                {{ form.thumbnail_file.label(class="block text-sm font-medium text-white mb-2") }}
                                <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center hover:border-primary transition-colors" id="thumb-drop-zone">
                                    {{ form.thumbnail_file(class="hidden", id="thumbnail_file_input", accept="image/*") }}
                                    <div id="thumb-drop-text">
                                        <i class="fas fa-image text-2xl text-gray-400 mb-2"></i>
                                        <p class="text-white mb-1">Drop thumbnail or <span class="text-primary cursor-pointer" onclick="document.getElementById('thumbnail_file_input').click()">browse</span></p>
                                        <p class="text-xs text-gray-400">Recommended: 1280x720 (16:9 ratio)</p>
                                    </div>
                                    <div id="thumb-preview" style="display: none;">
                                        <img id="thumb-preview-img" src="" alt="Thumbnail preview" class="w-32 h-20 object-cover rounded border border-gray-600 mx-auto mb-2">
                                        <p class="text-green-400 text-sm" id="thumb-filename"></p>
                                        <button type="button" onclick="clearThumbnailFile()" class="text-red-500 hover:text-red-400 mt-2">
                                            <i class="fas fa-trash mr-1"></i>Remove
                                        </button>
                                    </div>
                                </div>
                                {% if form.thumbnail_file.errors %}
                                    <p class="text-red-500 text-sm mt-1">{{ form.thumbnail_file.errors[0] }}</p>
                                {% endif %}
                            </div>

                            <!-- Order -->
                            <div>
                                {{ form.order.label(class="block text-sm font-medium text-white mb-2") }}
                                {{ form.order(class="w-full px-3 py-2 bg-dark-lightest border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary") }}
                                <p class="text-sm text-gray-400 mt-1">Lower numbers appear first in the carousel (0 = first)</p>
                                {% if form.order.errors %}
                                    <p class="text-red-500 text-sm mt-1">{{ form.order.errors[0] }}</p>
                                {% endif %}
                            </div>

                            <!-- Active Status -->
                            <div class="flex items-center">
                                {{ form.is_active(class="w-4 h-4 text-primary bg-dark-lightest border-gray-600 rounded focus:ring-primary focus:ring-2") }}
                                {{ form.is_active.label(class="ml-2 text-sm text-white") }}
                            </div>

                            <!-- Submit Button -->
                            <div class="flex space-x-4">
                                <button type="submit" class="bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg font-semibold">
                                    <i class="fas fa-save mr-2"></i>Save Video
                                </button>
                                <a href="{{ url_for('admin.admin_media') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg">
                                    Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Guidance Panel -->
            <div class="lg:col-span-1">
                <!-- Video Type Guide -->
                <div class="bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-4 mb-6">
                    <h3 class="text-blue-300 font-semibold mb-3">
                        <i class="fas fa-info-circle mr-2"></i>Video Types
                    </h3>
                    <div class="space-y-3 text-sm">
                        <div class="bg-blue-800 bg-opacity-30 rounded p-3">
                            <h4 class="text-red-300 font-medium">
                                <i class="fab fa-youtube mr-1"></i>YouTube Videos
                            </h4>
                            <p class="text-blue-300 text-xs mt-1">Embed videos from YouTube. Fast loading, no storage needed.</p>
                        </div>
                        <div class="bg-blue-800 bg-opacity-30 rounded p-3">
                            <h4 class="text-green-300 font-medium">
                                <i class="fas fa-cloud-upload-alt mr-1"></i>Uploaded Videos
                            </h4>
                            <p class="text-blue-300 text-xs mt-1">Upload your own videos. Full control, faster playback, better mobile experience.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Guidelines -->
                <div class="bg-green-900 bg-opacity-30 border border-green-700 rounded-lg p-4">
                    <h3 class="text-green-300 font-semibold mb-3">
                        <i class="fas fa-lightbulb mr-2"></i>Best Practices
                    </h3>
                    <ul class="text-green-200 text-sm space-y-2">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle mt-0.5 mr-2 text-green-400 flex-shrink-0"></i>
                            Use high-quality thumbnails (1280x720)
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle mt-0.5 mr-2 text-green-400 flex-shrink-0"></i>
                            Keep video titles descriptive and engaging
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle mt-0.5 mr-2 text-green-400 flex-shrink-0"></i>
                            Add meaningful descriptions
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle mt-0.5 mr-2 text-green-400 flex-shrink-0"></i>
                            Consider video file sizes for uploads
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Video type selection handling
document.addEventListener('DOMContentLoaded', function() {
    const videoTypeRadios = document.querySelectorAll('input[name="video_type"]');
    const youtubeSection = document.getElementById('youtube-section');
    const uploadSection = document.getElementById('upload-section');
    
    function toggleSections() {
        const selectedType = document.querySelector('input[name="video_type"]:checked')?.value;
        
        if (selectedType === 'youtube') {
            youtubeSection.style.display = 'block';
            uploadSection.style.display = 'none';
        } else if (selectedType === 'upload') {
            youtubeSection.style.display = 'none';
            uploadSection.style.display = 'block';
        }
    }
    
    videoTypeRadios.forEach(radio => {
        radio.addEventListener('change', toggleSections);
    });
    
    // Initialize on page load
    toggleSections();
});

// Video file handling
document.getElementById('video_file_input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        showVideoPreview(file);
    }
});

function showVideoPreview(file) {
    const dropText = document.getElementById('drop-text');
    const preview = document.getElementById('video-preview');
    const filename = document.getElementById('video-filename');
    const filesize = document.getElementById('video-filesize');
    
    filename.textContent = file.name;
    filesize.textContent = formatFileSize(file.size);
    
    dropText.style.display = 'none';
    preview.style.display = 'block';
}

function clearVideoFile() {
    const input = document.getElementById('video_file_input');
    const dropText = document.getElementById('drop-text');
    const preview = document.getElementById('video-preview');
    
    input.value = '';
    dropText.style.display = 'block';
    preview.style.display = 'none';
}

// Thumbnail file handling
document.getElementById('thumbnail_file_input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        showThumbnailPreview(file);
    }
});

function showThumbnailPreview(file) {
    const dropText = document.getElementById('thumb-drop-text');
    const preview = document.getElementById('thumb-preview');
    const img = document.getElementById('thumb-preview-img');
    const filename = document.getElementById('thumb-filename');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        img.src = e.target.result;
        filename.textContent = file.name;
        
        dropText.style.display = 'none';
        preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
}

function clearThumbnailFile() {
    const input = document.getElementById('thumbnail_file_input');
    const dropText = document.getElementById('thumb-drop-text');
    const preview = document.getElementById('thumb-preview');
    
    input.value = '';
    dropText.style.display = 'block';
    preview.style.display = 'none';
}

// YouTube thumbnail generation
function generateThumbnail() {
    const youtubeUrl = document.getElementById('youtube_url').value;
    if (youtubeUrl) {
        const videoId = extractYouTubeId(youtubeUrl);
        if (videoId) {
            const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
            
            // Show preview in thumbnail section
            const img = document.getElementById('thumb-preview-img');
            const dropText = document.getElementById('thumb-drop-text');
            const preview = document.getElementById('thumb-preview');
            const filename = document.getElementById('thumb-filename');
            
            img.src = thumbnailUrl;
            filename.textContent = 'YouTube Auto-Generated Thumbnail';
            
            dropText.style.display = 'none';
            preview.style.display = 'block';
        } else {
            alert('Please enter a valid YouTube URL');
        }
    } else {
        alert('Please enter a YouTube URL first');
    }
}

function extractYouTubeId(url) {
    const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
        /youtube\.com\/v\/([^&\n?#]+)/,
        /youtube\.com\/shorts\/([^&\n?#]+)/
    ];
    
    for (let pattern of patterns) {
        const match = url.match(pattern);
        if (match) {
            return match[1];
        }
    }
    return null;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Drag and drop handling
['video-drop-zone', 'thumb-drop-zone'].forEach(zoneId => {
    const zone = document.getElementById(zoneId);
    
    zone.addEventListener('dragover', function(e) {
        e.preventDefault();
        zone.classList.add('border-primary');
    });
    
    zone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        zone.classList.remove('border-primary');
    });
    
    zone.addEventListener('drop', function(e) {
        e.preventDefault();
        zone.classList.remove('border-primary');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            
            if (zoneId === 'video-drop-zone') {
                document.getElementById('video_file_input').files = files;
                showVideoPreview(file);
            } else if (zoneId === 'thumb-drop-zone') {
                document.getElementById('thumbnail_file_input').files = files;
                showThumbnailPreview(file);
            }
        }
    });
});
</script>
{% endblock %} 
