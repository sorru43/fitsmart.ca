{% extends 'base.html' %}

{% block title %}Checkout - {{ plan.name }} - Fit Smart{% endblock %}

{% block head %}
{{ super() }}
<!-- Stripe JS -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ config.STRIPE_PUBLISHABLE_KEY }}');
</script>
<!-- Checkout JS -->
<script src="{{ url_for('static', filename='js/checkout.js') }}"></script>
{% endblock %}

{% block content %}
<div class="bg-black py-8">
    <div class="container mx-auto px-4">
        <h1 class="text-3xl font-bold mb-6 text-white">Checkout - {{ plan.name }}</h1>
        
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Checkout Form -->
            <div class="lg:w-2/3">
                <div class="bg-gray-900 rounded-lg shadow-md overflow-hidden mb-8">
                    <div class="p-6">
                        <h2 class="text-xl font-bold mb-6 text-white">Plan Details</h2>
                        
                        <!-- Plan Selection -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-4 text-white">Delivery Frequency</h3>
                            <div class="flex gap-4">
                                <label class="flex items-center">
                                    <input type="radio" name="frequency" value="weekly" 
                                           {% if frequency == 'weekly' %}checked{% endif %}
                                           class="form-radio h-5 w-5 text-primary">
                                    <span class="ml-2 text-white">Weekly</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="frequency" value="monthly"
                                           {% if frequency == 'monthly' %}checked{% endif %}
                                           class="form-radio h-5 w-5 text-primary">
                                    <span class="ml-2 text-white">Monthly</span>
                                </label>
                            </div>
                        </div>

                        <!-- Vegetarian Days Selection -->
                        <div class="mb-6" id="vegetarian-days-section" {% if not show_veg_days %}style="display: none;"{% endif %}>
                            <h3 class="text-lg font-semibold mb-4 text-white">Select Vegetarian Days</h3>
                            <div class="grid grid-cols-5 gap-2">
                                {% for day in ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'] %}
                                <div class="flex flex-col items-center">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="veg_days" value="{{ loop.index0 }}" class="form-checkbox h-5 w-5 text-primary">
                                        <span class="ml-2 text-sm text-white">{{ day }}</span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            <p class="mt-2 text-sm text-gray-400">Select the days you want vegetarian meals.</p>
                        </div>

                        <div class="border-t border-gray-700 pt-6">
                            <h2 class="text-xl font-bold mb-4 text-white">Delivery Information</h2>
                            
                            <form id="payment-form" action="{{ url_for('main.process_meal_plan_checkout', plan_id=plan.id) }}" method="POST" class="space-y-4"
                                  data-weekly-price="{{ plan.price_weekly }}"
                                  data-monthly-price="{{ plan.price_monthly }}"
                                  data-plan-id="{{ plan.id }}">
                                {{ form.csrf_token }}
                                <input type="hidden" name="frequency" id="frequency-input" value="{{ frequency }}">
                                <input type="hidden" name="selected_veg_days" id="selected-veg-days">
                                <input type="hidden" name="total_price" id="total-price-input" value="{{ price }}">
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="name" class="block text-sm font-medium text-gray-300 mb-1">Full Name</label>
                                        <input type="text" id="name" name="name" value="{{ user.name }}" required
                                               class="w-full px-4 py-2 rounded-md bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                    
                                    <div>
                                        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                                        <input type="email" id="email" name="email" value="{{ user.email }}" required
                                               class="w-full px-4 py-2 rounded-md bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                    
                                    <div>
                                        <label for="phone" class="block text-sm font-medium text-gray-300 mb-1">Phone Number</label>
                                        <input type="tel" id="phone" name="phone" value="{{ user.phone }}" required
                                               class="w-full px-4 py-2 rounded-md bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                    
                                    <div>
                                        <label for="address" class="block text-sm font-medium text-gray-300 mb-1">Delivery Address</label>
                                        <input type="text" id="address" name="address" value="{{ user.address }}" required
                                               class="w-full px-4 py-2 rounded-md bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                    
                                    <div>
                                        <label for="province" class="block text-sm font-medium text-gray-300 mb-1">Province</label>
                                        <select id="province" name="province" required
                                                class="w-full px-4 py-2 rounded-md bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                            <option value="">Select Province</option>
                                            {% for code, name in form.province.choices[1:] %}
                                            <option value="{{ code }}" {% if user.province == code %}selected{% endif %}>{{ name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label for="city" class="block text-sm font-medium text-gray-300 mb-1">City</label>
                                        <select id="city" name="city" required
                                                class="w-full px-4 py-2 rounded-md bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                            <option value="">Select City</option>
                                            <option value="Toronto" {% if user.city == 'Toronto' %}selected{% endif %}>Toronto</option>
                                            <option value="Vancouver" {% if user.city == 'Vancouver' %}selected{% endif %}>Vancouver</option>
                                            <option value="Montreal" {% if user.city == 'Montreal' %}selected{% endif %}>Montreal</option>
                                            <option value="Calgary" {% if user.city == 'Calgary' %}selected{% endif %}>Calgary</option>
                                            <option value="Other" {% if user.city not in ['Toronto', 'Vancouver', 'Montreal', 'Calgary'] %}selected{% endif %}>Other</option>
                                        </select>
                                    </div>
                                    
                                    <div id="other-location-container" style="display: none;">
                                        <label for="other_location" class="block text-sm font-medium text-gray-300 mb-1">Enter Your Location</label>
                                        <input type="text" id="other_location" name="other_location" value="{{ user.city if user.city not in ['Toronto', 'Vancouver', 'Montreal', 'Calgary'] else '' }}"
                                               class="w-full px-4 py-2 rounded-md bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                    
                                    <div>
                                        <label for="postal_code" class="block text-sm font-medium text-gray-300 mb-1">Postal Code</label>
                                        <input type="text" id="postal_code" name="postal_code" value="{{ user.postal_code }}" required
                                               class="w-full px-4 py-2 rounded-md bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                </div>
                                
                                <div class="mt-6">
                                    <label for="delivery_instructions" class="block text-sm font-medium text-gray-300 mb-1">Delivery Instructions (Optional)</label>
                                    <textarea id="delivery_instructions" name="delivery_instructions" rows="3"
                                              class="w-full px-4 py-2 rounded-md bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                                </div>
                                
                                <div class="mt-6">
                                    <label for="coupon_code" class="block text-sm font-medium text-gray-300 mb-1">Coupon Code (Optional)</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="coupon_code" name="coupon_code"
                                               class="flex-1 px-4 py-2 rounded-md bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                        <button type="button" id="apply-coupon" 
                                                class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary">
                                            Apply
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mt-6">
                                    <button type="submit" id="submit-button"
                                            class="w-full px-6 py-3 bg-primary text-white rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary">
                                        <span id="button-text">Proceed to Payment</span>
                                        <span id="spinner" class="hidden">
                                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                        </span>
                                    </button>
                                </div>
                                
                                <div id="payment-message" class="hidden mt-4 p-4 rounded-md"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Order Summary -->
            <div class="lg:w-1/3">
                <div class="bg-gray-900 rounded-lg shadow-md overflow-hidden">
                    <div class="p-6">
                        <h2 class="text-xl font-bold mb-6 text-white">Order Summary</h2>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between">
                                <span class="text-gray-300">Plan:</span>
                                <span class="text-white">{{ plan.name }}</span>
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="text-gray-300">Frequency:</span>
                                <span class="text-white" id="summary-frequency">{{ frequency|title }}</span>
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="text-gray-300">Subtotal:</span>
                                <span class="text-white" id="summary-subtotal">${{ "%.2f"|format(price) }}</span>
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="text-gray-300">Discount:</span>
                                <span class="text-white" id="summary-discount">$0.00</span>
                            </div>
                            
                            <div class="border-t border-gray-700 pt-4">
                                <div class="flex justify-between">
                                    <span class="text-lg font-bold text-white">Total:</span>
                                    <span class="text-lg font-bold text-white" id="summary-total">${{ "%.2f"|format(price) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const citySelect = document.getElementById('city');
    const otherLocationContainer = document.getElementById('other-location-container');
    const otherLocationInput = document.getElementById('other_location');
    
    // Show/hide other location input based on city selection
    citySelect.addEventListener('change', function() {
        if (this.value === 'Other') {
            otherLocationContainer.style.display = 'block';
            otherLocationInput.required = true;
        } else {
            otherLocationContainer.style.display = 'none';
            otherLocationInput.required = false;
        }
    });
    
    // Trigger change event on load to set initial state
    citySelect.dispatchEvent(new Event('change'));
    
    // Handle frequency selection
    const frequencyRadios = document.querySelectorAll('input[name="frequency"]');
    const frequencyInput = document.getElementById('frequency-input');
    const summaryFrequency = document.getElementById('summary-frequency');
    const summarySubtotal = document.getElementById('summary-subtotal');
    const summaryTotal = document.getElementById('summary-total');
    
    frequencyRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            frequencyInput.value = this.value;
            summaryFrequency.textContent = this.value.charAt(0).toUpperCase() + this.value.slice(1);
            
            // Update price based on frequency
            const price = this.value === 'monthly' ? {{ plan.price_monthly }} : {{ plan.price_weekly }};
            summarySubtotal.textContent = '$' + price.toFixed(2);
            summaryTotal.textContent = '$' + price.toFixed(2);
            
            // Update hidden input
            document.getElementById('total-price-input').value = price;
        });
    });
    
    // Handle vegetarian days selection
    const vegDayCheckboxes = document.querySelectorAll('input[name="veg_days"]');
    const selectedVegDaysInput = document.getElementById('selected-veg-days');
    
    vegDayCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const selectedDays = Array.from(vegDayCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            selectedVegDaysInput.value = JSON.stringify(selectedDays);
        });
    });
});
</script>
{% endblock %} 