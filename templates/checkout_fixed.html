{% extends "base.html" %}

{% block title %}Checkout - HealthyRizz{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-white mb-8">Complete Your Order</h1>
        
        <div class="grid md:grid-cols-2 gap-8">
            <!-- Order Form -->
            <div class="bg-darker p-6 rounded-lg border border-gray-800">
                <h2 class="text-xl font-semibold mb-6 text-white">Customer Information</h2>
                
                <form id="checkout-form" method="POST" action="{{ url_for('main.process_checkout') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="plan_id" value="{{ meal_plan.id }}">
                    <input type="hidden" name="frequency" value="{{ frequency }}">
                    <input type="hidden" name="total_amount" value="{{ total_amount }}">
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Full Name *</label>
                            <input type="text" name="customer_name" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600" 
                                   value="{{ current_user.name if current_user.is_authenticated else '' }}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Email Address *</label>
                            <input type="email" name="customer_email" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600"
                                   value="{{ current_user.email if current_user.is_authenticated else '' }}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Phone Number *</label>
                            <input type="tel" name="customer_phone" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600"
                                   value="{{ current_user.phone if current_user.is_authenticated else '' }}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Address *</label>
                            <textarea name="customer_address" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600" rows="3">{{ current_user.address if current_user.is_authenticated else '' }}</textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-white">City *</label>
                                <input type="text" name="customer_city" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600"
                                       value="{{ current_user.city if current_user.is_authenticated else '' }}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-white">State *</label>
                                <input type="text" name="customer_state" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600"
                                       value="{{ current_user.state if current_user.is_authenticated else '' }}">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">PIN Code *</label>
                            <input type="text" name="customer_pincode" required class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600"
                                   value="{{ current_user.postal_code if current_user.is_authenticated else '' }}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-white">Delivery Instructions</label>
                            <textarea name="delivery_instructions" class="w-full px-3 py-2 rounded-md bg-dark text-white border border-gray-600" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <button type="submit" id="pay-button" class="w-full bg-primary text-white py-3 px-6 rounded-md hover:bg-green-600 font-semibold">
                            <i class="fas fa-credit-card mr-2"></i>Proceed to Payment (₹{{ total_amount }})
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Order Summary -->
            <div class="bg-darker p-6 rounded-lg border border-gray-800">
                <h2 class="text-xl font-semibold mb-6 text-white">Order Summary</h2>
                
                <div class="space-y-4">
                    <div class="flex justify-between">
                        <span class="text-gray-300">Plan:</span>
                        <span class="text-white font-semibold">{{ meal_plan.name }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Frequency:</span>
                        <span class="text-white">{{ frequency.title() }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Base Price:</span>
                        <span class="text-white">₹{{ base_price }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">GST (5%):</span>
                        <span class="text-white">₹{{ gst_amount }}</span>
                    </div>
                    <div class="border-t border-gray-700 pt-4">
                        <div class="flex justify-between font-semibold text-lg">
                            <span class="text-white">Total:</span>
                            <span class="text-primary">₹{{ total_amount }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.getElementById('checkout-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const button = document.getElementById('pay-button');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
    
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrf_token')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const options = {
                key: data.key_id,
                amount: data.amount,
                currency: data.currency,
                name: 'HealthyRizz',
                description: data.description,
                order_id: data.order_id,
                handler: function(response) {
                    // Payment successful - submit verification
                    const verifyForm = document.createElement('form');
                    verifyForm.method = 'POST';
                    verifyForm.action = '{{ url_for("main.verify_payment") }}';
                    verifyForm.style.display = 'none';
                    
                    // Add CSRF token
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrf_token';
                    csrfInput.value = formData.get('csrf_token');
                    verifyForm.appendChild(csrfInput);
                    
                    // Add payment details
                    const paymentIdInput = document.createElement('input');
                    paymentIdInput.type = 'hidden';
                    paymentIdInput.name = 'razorpay_payment_id';
                    paymentIdInput.value = response.razorpay_payment_id;
                    verifyForm.appendChild(paymentIdInput);
                    
                    const orderIdInput = document.createElement('input');
                    orderIdInput.type = 'hidden';
                    orderIdInput.name = 'razorpay_order_id';
                    orderIdInput.value = response.razorpay_order_id;
                    verifyForm.appendChild(orderIdInput);
                    
                    const signatureInput = document.createElement('input');
                    signatureInput.type = 'hidden';
                    signatureInput.name = 'razorpay_signature';
                    signatureInput.value = response.razorpay_signature;
                    verifyForm.appendChild(signatureInput);
                    
                    document.body.appendChild(verifyForm);
                    verifyForm.submit();
                },
                prefill: {
                    name: formData.get('customer_name'),
                    email: formData.get('customer_email'),
                    contact: formData.get('customer_phone')
                },
                theme: {
                    color: '#4CAF50'
                }
            };
            
            const rzp = new Razorpay(options);
            rzp.open();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your checkout.');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Proceed to Payment (₹{{ total_amount }})';
    });
});
</script>
{% endblock %}
