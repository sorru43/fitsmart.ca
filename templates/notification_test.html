{% extends 'base.html' %}

{% block title %}HealthyRizz - Test Notifications{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2>Push Notification Testing</h2>
                </div>
                <div class="card-body">
                    <p class="lead">
                        Use this page to test push notifications in the HealthyRizz application.
                    </p>
                    
                    <div class="alert alert-info">
                        <strong>Note:</strong> You must enable notifications in your browser to receive push notifications.
                    </div>
                    
                    <!-- Notification Permission Button -->
                    {% include 'static/templates/notification-button.html' %}
                    
                    <hr class="my-4">
                    
                    <h3>Send Test Notification</h3>
                    
                    <form id="send-notification-form" class="mt-3">
                        <div class="form-group mb-3">
                            <label for="title">Notification Title</label>
                            <input type="text" class="form-control" id="title" value="HealthyRizz Test Notification">
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="message">Notification Message</label>
                            <textarea class="form-control" id="message" rows="3">This is a test message from HealthyRizz!</textarea>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="url">URL to Open (when clicked)</label>
                            <input type="text" class="form-control" id="url" value="/notifications">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Send Test Notification</button>
                    </form>
                    
                    <div id="notification-status" class="alert mt-3" style="display: none;"></div>
                    
                    <hr class="my-4">
                    
                    <h3>Generate VAPID Keys</h3>
                    <p>
                        Before you can send push notifications, you need to generate VAPID keys.
                        These keys are used to authenticate your server when sending notifications.
                    </p>
                    
                    <div class="alert alert-warning">
                        <strong>Warning:</strong> This will generate new VAPID keys. If you already have keys, they will be replaced.
                    </div>
                    
                    <form id="generate-keys-form">
                        <div class="form-group mb-3">
                            <label for="contact-email">Contact Email (for VAPID)</label>
                            <input type="email" class="form-control" id="contact-email" value="admin@healthyrizz.in">
                            <small class="form-text text-muted">This email address is used for the VAPID protocol and is not shared with users.</small>
                        </div>
                        
                        <button type="submit" class="btn btn-warning">Generate New VAPID Keys</button>
                    </form>
                    
                    <div id="keys-status" class="alert mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const notificationForm = document.getElementById('send-notification-form');
        const notificationStatus = document.getElementById('notification-status');
        const keysForm = document.getElementById('generate-keys-form');
        const keysStatus = document.getElementById('keys-status');
        
        // Send test notification
        if (notificationForm) {
            notificationForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Check if notification permission is granted
                if (Notification.permission !== 'granted') {
                    showStatus(notificationStatus, 'You need to enable notifications first!', 'warning');
                    return;
                }
                
                // Prepare notification data
                const notificationData = {
                    title: document.getElementById('title').value,
                    message: document.getElementById('message').value,
                    url: document.getElementById('url').value
                };
                
                showStatus(notificationStatus, 'Sending notification...', 'info');
                
                // Send to server
                fetch('/api/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(notificationData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus(notificationStatus, `Notification sent successfully! (${data.sent} sent, ${data.failed} failed)`, 'success');
                    } else {
                        showStatus(notificationStatus, `Error: ${data.error}`, 'danger');
                    }
                })
                .catch(error => {
                    showStatus(notificationStatus, `Error: ${error.message}`, 'danger');
                });
            });
        }
        
        // Generate VAPID keys
        if (keysForm) {
            keysForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('contact-email').value;
                
                showStatus(keysStatus, 'Generating VAPID keys...', 'info');
                
                // Call the server to generate keys
                fetch('/api/generate-vapid-keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus(keysStatus, 'VAPID keys generated successfully! Refresh the page to use them.', 'success');
                    } else {
                        showStatus(keysStatus, `Error: ${data.error}`, 'danger');
                    }
                })
                .catch(error => {
                    showStatus(keysStatus, `Error: ${error.message}`, 'danger');
                });
            });
        }
        
        // Helper function to show status
        function showStatus(element, message, type) {
            element.textContent = message;
            element.style.display = 'block';
            
            // Remove all classes
            element.classList.remove('alert-success', 'alert-danger', 'alert-warning', 'alert-info');
            
            // Add the appropriate class
            element.classList.add(`alert-${type}`);
        }
    });
</script>
{% endblock %}