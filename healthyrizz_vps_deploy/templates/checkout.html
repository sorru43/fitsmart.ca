{% extends 'base.html' %}

{% block title %}Checkout - HealthyRizz{% endblock %}

{% block head %}
{{ super() }}
<!-- Razorpay JS -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<style>
.checkout-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 2rem 0;
}

.checkout-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    padding: 2rem;
    margin-bottom: 2rem;
}

.checkout-title {
    color: #333;
    font-weight: 700;
    margin-bottom: 2rem;
    text-align: center;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-control {
    border: 2px solid #e1e5e9;
    border-radius: 10px;
    padding: 12px 15px;
    font-size: 16px;
    transition: all 0.3s ease;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 10px;
    padding: 12px 30px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.order-summary-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    position: sticky;
    top: 2rem;
}

.order-summary-title {
    color: white;
    font-weight: 700;
    margin-bottom: 1.5rem;
    text-align: center;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.75rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.2);
}

.summary-total {
    font-weight: 700;
    font-size: 1.2rem;
    border-top: 2px solid rgba(255,255,255,0.3);
    padding-top: 1rem;
    margin-top: 1rem;
}

.form-label {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
}

.form-text {
    color: #6c757d;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}
<div class="checkout-container">
    <div class="container">
        <div class="checkout-card">
            <h2 class="checkout-title">Complete Your Order</h2>
            
            <div class="row">
                <div class="col-lg-8">
                    <form id="checkout-form" method="POST" action="{{ url_for('main.process_checkout') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="plan_id" value="{{ plan.id }}">
                        <input type="hidden" name="frequency" value="{{ frequency }}">
                        <input type="hidden" name="razorpay_payment_id" id="razorpay_payment_id">
                        <input type="hidden" name="razorpay_order_id" id="razorpay_order_id">
                        <input type="hidden" name="razorpay_signature" id="razorpay_signature">
                        
                        <div class="form-group">
                            <label for="customer_name" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="customer_name" name="customer_name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="customer_email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="customer_email" name="customer_email" value="{{ current_user.email if current_user.is_authenticated else '' }}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="customer_phone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="customer_phone" name="customer_phone" pattern="[6-9]\d{9}" required>
                            <small class="form-text">Enter a valid 10-digit Indian mobile number</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="customer_address" class="form-label">Delivery Address</label>
                            <textarea class="form-control" id="customer_address" name="customer_address" rows="3" required></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="customer_city" class="form-label">City</label>
                                    <input type="text" class="form-control" id="customer_city" name="customer_city" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="customer_state" class="form-label">State</label>
                                    <input type="text" class="form-control" id="customer_state" name="customer_state" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="customer_pincode" class="form-label">Pincode</label>
                            <input type="text" class="form-control" id="customer_pincode" name="customer_pincode" pattern="\d{6}" required>
                            <small class="form-text">Enter a valid 6-digit pincode</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="vegetarian_days" class="form-label">Vegetarian Days (Optional)</label>
                            <select class="form-control" id="vegetarian_days" name="vegetarian_days" multiple>
                                <option value="monday">Monday</option>
                                <option value="tuesday">Tuesday</option>
                                <option value="wednesday">Wednesday</option>
                                <option value="thursday">Thursday</option>
                                <option value="friday">Friday</option>
                            </select>
                            <small class="form-text">Select days for vegetarian meals</small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-credit-card me-2"></i>Proceed to Payment
                        </button>
                    </form>
                </div>
                
                <div class="col-lg-4">
                    <div class="order-summary-card">
                        <h5 class="order-summary-title">Order Summary</h5>
                        <div class="summary-item">
                            <span>Plan:</span>
                            <span>{{ plan.name }}</span>
                        </div>
                        <div class="summary-item">
                            <span>Frequency:</span>
                            <span>{{ frequency|title }}</span>
                        </div>
                        <div class="summary-item">
                            <span>Base Price:</span>
                            <span>₹{{ "%.2f"|format(plan.price_weekly if frequency == 'weekly' else plan.price_monthly) }}</span>
                        </div>
                        <div class="summary-item">
                            <span>GST (5%):</span>
                            <span>₹{{ "%.2f"|format((plan.price_weekly if frequency == 'weekly' else plan.price_monthly) * 0.05) }}</span>
                        </div>
                        <div class="summary-item summary-total">
                            <span>Total:</span>
                            <span>₹{{ "%.2f"|format((plan.price_weekly if frequency == 'weekly' else plan.price_monthly) * 1.05) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('checkout-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Get form data
    const formData = new FormData(this);
    
    // Send form data to server
    fetch('{{ url_for("main.process_checkout") }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Initialize Razorpay
        const options = {
            key: data.key,
            amount: data.amount,
            currency: data.currency,
            name: data.name,
            description: data.description,
            order_id: data.order_id,
            prefill: data.prefill,
            theme: data.theme,
            handler: function(response) {
                // Set payment details in hidden fields
                document.getElementById('razorpay_payment_id').value = response.razorpay_payment_id;
                document.getElementById('razorpay_order_id').value = response.razorpay_order_id;
                document.getElementById('razorpay_signature').value = response.razorpay_signature;
                
                // Submit form to verify payment
                const verifyForm = document.createElement('form');
                verifyForm.method = 'POST';
                verifyForm.action = '{{ url_for("main.verify_payment") }}';
                
                // Add CSRF token
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = '{{ csrf_token() }}';
                verifyForm.appendChild(csrfInput);
                
                // Add payment details
                const paymentIdInput = document.createElement('input');
                paymentIdInput.type = 'hidden';
                paymentIdInput.name = 'razorpay_payment_id';
                paymentIdInput.value = response.razorpay_payment_id;
                verifyForm.appendChild(paymentIdInput);
                
                const orderIdInput = document.createElement('input');
                orderIdInput.type = 'hidden';
                orderIdInput.name = 'razorpay_order_id';
                orderIdInput.value = response.razorpay_order_id;
                verifyForm.appendChild(orderIdInput);
                
                const signatureInput = document.createElement('input');
                signatureInput.type = 'hidden';
                signatureInput.name = 'razorpay_signature';
                signatureInput.value = response.razorpay_signature;
                verifyForm.appendChild(signatureInput);
                
                document.body.appendChild(verifyForm);
                verifyForm.submit();
            },
            modal: {
                ondismiss: function() {
                    console.log('Checkout form closed');
                }
            }
        };
        
        const rzp = new Razorpay(options);
        rzp.open();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your order. Please try again.');
    });
});
</script>
{% endblock %}
