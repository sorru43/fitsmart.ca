{% extends 'admin/base_admin.html' %}

{% block title %}Admin - Send Notifications{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-2xl font-bold text-white mb-6">Send Notifications</h1>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="md:col-span-2">
            <!-- Notification Form Card -->
            <div class="bg-dark-lighter rounded-lg shadow-md overflow-hidden mb-6">
                <div class="bg-primary p-4">
                    <h5 class="text-white font-semibold">Compose Notification</h5>
                </div>
                <div class="p-6">
                    <form id="notification-form" method="POST" action="{{ url_for('admin.send_notification') }}">
                        {{ form.csrf_token }}
                        
                        <div class="mb-4">
                            <label for="title" class="block text-sm font-medium text-gray-300 mb-2">Notification Title</label>
                            <input type="text" class="w-full px-3 py-2 bg-dark border border-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" 
                                   id="title" name="title" required value="{{ form.title.data or 'HealthyRizz Update' }}">
                            <small class="text-gray-400">Keep titles concise (40-50 characters max)</small>
                        </div>
                        
                        <div class="mb-4">
                            <label for="message" class="block text-sm font-medium text-gray-300 mb-2">Notification Message</label>
                            <textarea class="w-full px-3 py-2 bg-dark border border-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" 
                                      id="message" name="message" rows="3" required>{{ form.message.data or '' }}</textarea>
                            <small class="text-gray-400">Keep messages brief and clear (100-120 characters recommended)</small>
                        </div>

                        <div class="mb-4">
                            <label for="email_subject" class="block text-sm font-medium text-gray-300 mb-2">Email Subject</label>
                            <input type="text" class="w-full px-3 py-2 bg-dark border border-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" 
                                   id="email_subject" name="email_subject" required>
                        </div>

                        <div class="mb-4">
                            <label for="email_content" class="block text-sm font-medium text-gray-300 mb-2">Email Content</label>
                            <textarea class="w-full px-3 py-2 bg-dark border border-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" 
                                      id="email_content" name="email_content" rows="5" required></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Channels</label>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="push_notification" name="channels" value="push" class="text-primary" checked>
                                    <label for="push_notification" class="ml-2 text-gray-300">Push Notification</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="email" name="channels" value="email" class="text-primary" checked>
                                    <label for="email" class="ml-2 text-gray-300">Email</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="sms" name="channels" value="sms" class="text-primary">
                                    <label for="sms" class="ml-2 text-gray-300">SMS</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="recipient_type" class="block text-sm font-medium text-gray-300 mb-2">Recipients</label>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input type="radio" id="all_users" name="recipient_type" value="all" class="text-primary" checked>
                                    <label for="all_users" class="ml-2 text-gray-300">All Users</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="subscribers" name="recipient_type" value="subscribers" class="text-primary">
                                    <label for="subscribers" class="ml-2 text-gray-300">Active Subscribers Only</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="specific" name="recipient_type" value="specific" class="text-primary">
                                    <label for="specific" class="ml-2 text-gray-300">Specific User</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4 hidden" id="specific-user-container">
                            <label for="user_id" class="block text-sm font-medium text-gray-300 mb-2">Select User</label>
                            <select class="w-full px-3 py-2 bg-dark border border-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" 
                                    id="user_id" name="user_id">
                                <option value="">-- Select User --</option>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.email }} ({{ user.name }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label for="notification_type" class="block text-sm font-medium text-gray-300 mb-2">Notification Type</label>
                            <select class="w-full px-3 py-2 bg-dark border border-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" 
                                    id="notification_type" name="notification_type">
                                <option value="general" selected>General Announcement</option>
                                <option value="promotion">Promotion/Special Offer</option>
                                <option value="order_update">Order Update</option>
                                <option value="delivery">Delivery Information</option>
                                <option value="account">Account Update</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="w-full bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                            Send Notification
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="md:col-span-1">
            <!-- Statistics Card -->
            <div class="bg-dark-lighter rounded-lg shadow-md overflow-hidden mb-6">
                <div class="bg-info p-4">
                    <h5 class="text-white font-semibold">Notification Statistics</h5>
                </div>
                <div class="p-4">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">Total Subscribers</span>
                            <span class="bg-primary text-white px-3 py-1 rounded-full text-sm">{{ subscription_count }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">Email Subscribers</span>
                            <span class="bg-info text-white px-3 py-1 rounded-full text-sm">{{ email_subscribers_count }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">Push Subscribers</span>
                            <span class="bg-success text-white px-3 py-1 rounded-full text-sm">{{ push_subscribers_count }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">SMS Subscribers</span>
                            <span class="bg-warning text-white px-3 py-1 rounded-full text-sm">{{ sms_subscribers_count }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Templates -->
            <div class="bg-dark-lighter rounded-lg shadow-md overflow-hidden mb-6">
                <div class="bg-secondary p-4">
                    <h5 class="text-white font-semibold">Quick Templates</h5>
                </div>
                <div class="p-4">
                    <div class="space-y-2">
                        <button type="button" class="w-full text-left p-2 rounded hover:bg-dark-lightest text-gray-300" 
                                data-template-title="New Meal Added!" 
                                data-template-message="Check out our delicious new meal option, now available for ordering."
                                data-template-email-subject="New Meal Plan Available!"
                                data-template-email-content="We're excited to announce our new meal plan option. Check it out now and enjoy a special discount for early subscribers!">
                            New Menu Item
                        </button>
                        <button type="button" class="w-full text-left p-2 rounded hover:bg-dark-lightest text-gray-300"
                                data-template-title="Special Offer Inside"
                                data-template-message="Limited time only: Get 15% off your next order with code SPECIAL15"
                                data-template-email-subject="Special Offer: 15% Off Your Next Order"
                                data-template-email-content="Don't miss out on our special offer! Use code SPECIAL15 to get 15% off your next order. Limited time only.">
                            Special Offer
                        </button>
                        <button type="button" class="w-full text-left p-2 rounded hover:bg-dark-lightest text-gray-300"
                                data-template-title="Your Delivery is on the Way"
                                data-template-message="Your meal delivery is en route and will arrive shortly."
                                data-template-email-subject="Your HealthyRizz Delivery is On Its Way"
                                data-template-email-content="Great news! Your HealthyRizz meal delivery is on its way and will arrive shortly. Track your delivery in real-time through our app.">
                            Delivery Update
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Notifications -->
    <div class="bg-dark-lighter rounded-lg shadow-md overflow-hidden mt-6">
        <div class="bg-dark p-4">
            <h5 class="text-white font-semibold">Recent Notifications</h5>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-dark">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date/Time</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Title</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Channels</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Recipients</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Sent By</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">
                    {% for notification in recent_notifications %}
                    <tr class="hover:bg-dark-lightest">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ notification.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-white">{{ notification.title }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if notification.notification_type == 'general' %}bg-gray-700 text-gray-300
                                {% elif notification.notification_type == 'promotion' %}bg-yellow-900 text-yellow-200
                                {% elif notification.notification_type == 'delivery' %}bg-blue-900 text-blue-200
                                {% else %}bg-primary text-white{% endif %}">
                                {{ notification.notification_type }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                            {% if notification.channels %}
                                {% for channel in notification.channels.split(',') %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                        {% if channel == 'push' %}bg-blue-900 text-blue-200
                                        {% elif channel == 'email' %}bg-green-900 text-green-200
                                        {% elif channel == 'sms' %}bg-purple-900 text-purple-200
                                        {% endif %}">
                                        {{ channel|upper }}
                                    </span>
                                {% endfor %}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ notification.recipient_count }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if notification.status == 'sent' %}bg-green-900 text-green-200
                                {% elif notification.status == 'failed' %}bg-red-900 text-red-200
                                {% elif notification.status == 'pending' %}bg-yellow-900 text-yellow-200
                                {% else %}bg-gray-700 text-gray-300{% endif %}">
                                {{ notification.status|title }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ notification.sent_by_user.name }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-400">No notifications have been sent yet</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle recipient type radio buttons
    const recipientTypeInputs = document.querySelectorAll('input[name="recipient_type"]');
    const specificUserContainer = document.getElementById('specific-user-container');
    
    recipientTypeInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.value === 'specific') {
                specificUserContainer.classList.remove('hidden');
            } else {
                specificUserContainer.classList.add('hidden');
            }
        });
    });

    // Handle quick templates
    const templateButtons = document.querySelectorAll('[data-template-title]');
    const titleInput = document.getElementById('title');
    const messageInput = document.getElementById('message');
    const emailSubjectInput = document.getElementById('email_subject');
    const emailContentInput = document.getElementById('email_content');
    
    templateButtons.forEach(button => {
        button.addEventListener('click', function() {
            titleInput.value = this.getAttribute('data-template-title');
            messageInput.value = this.getAttribute('data-template-message');
            emailSubjectInput.value = this.getAttribute('data-template-email-subject');
            emailContentInput.value = this.getAttribute('data-template-email-content');
        });
    });
});
</script>
{% endblock %}
